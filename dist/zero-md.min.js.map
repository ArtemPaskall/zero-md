{"version":3,"file":"zero-md.min.js","sources":["../src/index.js"],"sourcesContent":["import { version } from '../package.json'\n\nexport class ZeroMd extends HTMLElement {\n  get src () { return this.getAttribute('src') }\n  set src (val) { this.reflect('src', val) }\n  get manualRender () { return this.hasAttribute('manual-render') }\n  set manualRender (val) { this.reflect('manual-render', val) }\n  get noShadow () { return this.hasAttribute('no-shadow') }\n\n  reflect (name, val) {\n    if (val === false) {\n      this.removeAttribute(name)\n    } else {\n      this.setAttribute(name, val === true ? '' : val)\n    }\n  }\n\n  static get observedAttributes () {\n    return ['src']\n  }\n\n  attributeChangedCallback (name, old, val) {\n    if (name === 'src' && old !== null && old !== val && !this.manualRender) {\n      this.render()\n    }\n  }\n\n  constructor (defaults) {\n    super()\n    this.version = version\n    this.config = {\n      markedUrl: 'https://cdn.jsdelivr.net/gh/markedjs/marked@1/marked.min.js',\n      prismUrl: [\n        ['https://cdn.jsdelivr.net/gh/PrismJS/prism@1/components/prism-core.min.js', 'data-manual'],\n        'https://cdn.jsdelivr.net/gh/PrismJS/prism@1/plugins/autoloader/prism-autoloader.min.js'\n      ],\n      cssUrls: [\n        'https://cdn.jsdelivr.net/gh/sindresorhus/github-markdown-css@4/github-markdown.min.css',\n        'https://cdn.jsdelivr.net/gh/PrismJS/prism@1/themes/prism.min.css'\n      ],\n      hostCss: ':host{display:block;position:relative;contain:content;}:host([hidden]){display:none;}',\n      ...defaults,\n      ...window.ZeroMdConfig\n    }\n    this.root = this.noShadow ? this : this.attachShadow({ mode: 'open' })\n    if (!this.constructor.ready) {\n      this.constructor.ready = Promise.all([\n        !!window.marked || this.loadScript(this.config.markedUrl),\n        !!window.Prism || this.loadScript(this.config.prismUrl)\n      ])\n    }\n    this.ready = new Promise(resolve => {\n      this._resolve = resolve\n    })\n    this.waitForReady().then(() => {\n      this.fire('zero-md-ready')\n    })\n    if (!this.manualRender) {\n      // Scroll to hash id after first render. However, `history.scrollRestoration` inteferes with this on refresh.\n      // It's much better to use a `setTimeout` rather than to alter the browser's behaviour.\n      this.render().then(() => setTimeout(() => this.goto(location.hash), 250))\n    }\n    this.addEventListener('click', this.clicked)\n  }\n\n  connectedCallback () {\n    this._resolve()\n    delete this._resolve\n  }\n\n  disconnectedCallback () {\n    this.removeEventListener('click', this.clicked)\n  }\n\n  waitForReady () {\n    return Promise.all([this.constructor.ready, this.ready])\n  }\n\n  fire (name, detail = {}, composed = true) {\n    if (detail.msg) {\n      console.warn(detail.msg)\n    }\n    this.dispatchEvent(new CustomEvent(name, {\n      detail: { node: this, ...detail },\n      bubbles: true,\n      composed\n    }))\n  }\n\n  // Coerce anything into an array\n  arrify (any) {\n    return any ? (Array.isArray(any) ? any : [any]) : []\n  }\n\n  // Promisify an element's onload callback\n  onload (node) {\n    return new Promise((resolve, reject) => {\n      node.onload = resolve\n      node.onerror = err => reject(err.path ? err.path[0] : err.composedPath()[0])\n    })\n  }\n\n  // Load a url or load (in order) an array of urls via <script> tags\n  loadScript (urls) {\n    urls = this.arrify(urls)\n    return Promise.all(urls.map(item => {\n      const [url, ...attrs] = this.arrify(item)\n      const el = document.createElement('script')\n      el.src = url\n      el.async = false\n      attrs.forEach(attr => el.setAttribute(attr, ''))\n      return this.onload(document.head.appendChild(el))\n    }))\n  }\n\n  // Scroll to selected element\n  goto (sel) {\n    if (sel) {\n      const el = this.root.querySelector(sel)\n      if (el) {\n        el.scrollIntoView()\n      }\n    }\n  }\n\n  // Hijack same-doc anchor hash links\n  clicked (ev) {\n    if (!this.shadowRoot || ev.ctrlKey || ev.metaKey || ev.altKey || ev.shiftKey || ev.defaultPrevented) {\n      return\n    }\n    const a = ev.path ? ev.path[0] : ev.composedPath()[0]\n    if (a.tagName !== 'A' || !a.hash || a.host !== location.host || a.pathname !== location.pathname) {\n      return\n    }\n    this.goto(a.hash)\n  }\n\n  clearDom () {\n    if (this.shadowRoot) {\n      this.shadowRoot.innerHTML = ''\n    }\n    const nodes = this.querySelectorAll('[class^=markdown]')\n    nodes.forEach(n => n.remove())\n  }\n\n  // Converts HTML string into document fragment\n  makeFrag (html) {\n    const tpl = document.createElement('template')\n    tpl.innerHTML = html\n    return tpl.content\n  }\n\n  dedent (str) {\n    str = str.replace(/^\\n/, '')\n    const match = str.match(/^\\s+/)\n    return match ? str.replace(new RegExp(`^${match[0]}`, 'gm'), '') : str\n  }\n\n  getBaseUrl (src) {\n    const a = document.createElement('a')\n    a.href = src\n    return a.href.substring(0, a.href.lastIndexOf('/') + 1)\n  }\n\n  highlight (container) {\n    const unhinted = container.querySelectorAll('pre>code:not([class*=\"language-\"])')\n    unhinted.forEach(n => {\n      // Dead simple language detection :)\n      const lang = n.innerText.match(/^\\s*</) ? 'markup' : n.innerText.match(/^\\s*(\\$|#)/) ? 'bash' : 'js'\n      n.classList.add(`language-${lang}`)\n    })\n    window.Prism.highlightAllUnder(container)\n  }\n\n  // Construct styles dom and return document fragment\n  buildStyles () {\n    const get = query => {\n      const node = this.querySelector(query)\n      return node ? node.innerHTML : ''\n    }\n    const urls = this.arrify(this.config.cssUrls)\n    const html = `<div class=\"markdown-styles\"><style>${\n      this.config.hostCss}</style>${\n      get('template[data-merge=\"prepend\"]')}${\n      get('template:not([data-merge])') || urls.reduce((a, c) => `${a}<link rel=\"stylesheet\" href=\"${c}\">`, '')}${\n      get('template[data-merge=\"append\"]')}</div>`\n    return this.makeFrag(html)\n  }\n\n  // Construct md nodes and return promise that resolves to doc frag\n  async buildMd (opts = {}) {\n    const src = async () => {\n      if (!this.src) { return '' }\n      const resp = await fetch(this.src)\n      if (resp.ok) {\n        const md = await resp.text()\n        return window.marked(md, { baseUrl: this.getBaseUrl(this.src), ...opts })\n      } else {\n        this.fire('zero-md-error', { msg: `[zero-md] HTTP error ${resp.status} while fetching src`, status: resp.status, src: this.src })\n        return ''\n      }\n    }\n    const script = () => {\n      const el = this.querySelector('script[type=\"text/markdown\"]')\n      if (!el) { return '' }\n      const md = el.hasAttribute('data-dedent') ? this.dedent(el.text) : el.text\n      return window.marked(md, opts)\n    }\n    const html = `<div class=\"markdown-body${\n      opts.classes ? this.arrify(opts.classes).reduce((a, c) => `${a} ${c}`, ' ') : ''}\">${\n      await src() || script()}</div>`\n    const frag = this.makeFrag(html)\n    this.highlight(frag.firstElementChild)\n    return frag\n  }\n\n  // Stamps a fragment into DOM\n  async stampDom (frag) {\n    const links = [...frag.querySelectorAll('link[rel=\"stylesheet\"]')]\n    this.root.appendChild(frag.firstElementChild)\n    // Wrap all link elements with onload listener\n    await Promise.all(links.map(l => this.onload(l))).catch(err => {\n      this.fire('zero-md-error', { msg: '[zero-md] An external stylesheet failed to load', status: undefined, src: err.href })\n    })\n  }\n\n  async render (opts = {}) {\n    await this.waitForReady()\n    this.clearDom()\n    const css = this.buildStyles()\n    const md = this.buildMd(opts)\n    await this.stampDom(css)\n    await this.stampDom(await md)\n    this.fire('zero-md-rendered')\n  }\n}\n\ncustomElements.define('zero-md', ZeroMd)\n"],"names":["ZeroMd","HTMLElement","src","this","getAttribute","val","reflect","manualRender","hasAttribute","noShadow","[object Object]","name","removeAttribute","setAttribute","observedAttributes","old","render","defaults","super","version","config","markedUrl","prismUrl","cssUrls","hostCss","window","ZeroMdConfig","root","attachShadow","mode","constructor","ready","Promise","all","marked","loadScript","Prism","resolve","_resolve","waitForReady","then","fire","setTimeout","goto","location","hash","addEventListener","clicked","removeEventListener","detail","composed","msg","console","warn","dispatchEvent","CustomEvent","node","bubbles","any","Array","isArray","reject","onload","onerror","err","path","composedPath","urls","arrify","map","item","url","attrs","el","document","createElement","async","forEach","attr","head","appendChild","sel","querySelector","scrollIntoView","ev","shadowRoot","ctrlKey","metaKey","altKey","shiftKey","defaultPrevented","a","tagName","host","pathname","innerHTML","querySelectorAll","n","remove","html","tpl","content","str","match","replace","RegExp","href","substring","lastIndexOf","container","lang","innerText","classList","add","highlightAllUnder","get","query","reduce","c","makeFrag","opts","classes","resp","fetch","ok","md","text","baseUrl","getBaseUrl","status","dedent","script","frag","highlight","firstElementChild","links","l","catch","undefined","clearDom","css","buildStyles","buildMd","stampDom","customElements","define"],"mappings":"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"}